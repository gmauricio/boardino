<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>The Board</title>
    <link href="/media/css/board.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css"/>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
    <script type="text/javascript" src="/media/js/processing-1.3.6.js"></script>
    <script type="text/javascript" src="/media/js/json2.js"></script>
    <script type="text/javascript" src="/media/js/boardconnection.js"></script>
    <script type="application/javascript">
        var processingInstance;
        var boardConnection;

        function loadProcessingInstance(){
            var tId=0;
            tId=setInterval(function() {
                processingInstance = Processing.getInstanceById("board");
                if (processingInstance) clearInterval(tId);
            },1);
        }

        function loadBoard(){
            $.get('/{{ board_id }}/postits', function(json){
                $.each(json, function(i, postit){
                    createPostit(postit.id, postit.text,
                                               postit.x , postit.y);
                });
            });
            $.get('/{{ board_id }}/lines', function(json){
                $.each(json, function(i, line){
                    processingInstance.addLine(line.x, line.y , line.x1, line.y1);
                });
            });
            processingInstance.bindJavaScript(this);
        }

        function movePostit(id, newX, newY, text){
            $("#postit"+id).css('top', newY+"px");
            $("#postit"+id).css('left',newX+"px");
        }

        function updatePostitText(id, text){
            $("#postit_input"+id).val(text);
        }

        function updatePostitPosition(postitId, x, y){
            $.post('/postit/'+postitId+'/update/', { x:x, y:y });
        }

        function onUpdatePostit(id, x, y, text){
            $.post('/postit/'+id+'/update/', { text:text}, function(){
                boardConnection.updatePostitText(id, text);
            });
        }

        function onNewPostit(x, y){
            $.post('/{{ board_id }}/postit/new/', { text: "", x:x, y:y }, function(json){
                createPostit(json["postit_id"], "", x, y);
                boardConnection.newPostit({{ board_id }} , json["postit_id"], json["x"],json["y"],json["text"]);
            });
        }

        //TODO: refactorizar este m√©todo horrible
        function createPostit(id, text, x, y){
            var width = $(document).width()/8;
            var height = $(document).height()/4;
            var postitDivId = "postit"+id;
            $("\
                <div \
                       id='"+postitDivId+"'\
                       style='background-color: #FFFF33;\
                              position: absolute;\
                              top:"+(y)+"px;\
                              left:"+(x)+"px;\
                              width:"+width+"px; height:"+height+"px;\
                              padding: 2px 2px 25px 2px; '\
                />").appendTo("#board");
            $("#"+postitDivId).draggable({
                    drag: function(){
                        var position = $(this).position();
                        boardConnection.movePostit(id, position.left, position.top);
                    },
                    stop: function(){
                        var position = $(this).position();
                        updatePostitPosition(id, position.left, position.top);
                    }
            }).resizable();
            $("\
                <img src='/media/close.png' \
                       id='postit_close"+id+"'\
                       style='position: relative;\
                              float:right;\
                              top:0px;\
                              right:0px;'\
                />").appendTo("#"+postitDivId);

            $("#postit_close"+id).click(function(){
                onDeletedPostit(id);
            });

            var textAreaHeight = $("#postit"+id).height()-$("#postit_close"+id).height()-2;
            $("\
                <textarea \
                       class = 'postit_input'\
                       id='postit_input"+id+"'\
                       style='-moz-box-sizing:border-box;\
                              border:none;\
                              resize: none;\
                              display:block;\
                              background-color: #FFFF99;\
                              position: relative;\
                              padding:0px;\
                              top:0px;\
                              left:0px;\
                              width:100%;height:100%;'/>")
                    .appendTo("#"+postitDivId);
            $("#postit_input"+id).val(text);
            $("#postit_input"+id).keyup(function(){
                onUpdatePostit(id, x, y, $("#postit_input"+id).val());
            });
            if(text==""){
                $("#postit_input"+id).val("Write ...");
                setTimeout(function() { $("#postit_input"+id).focus().select(); }, 0);
            }
        }

        function onNewLine(x, y, x1, y1){
            $.post('/{{ board_id }}/line/new/', { x: x, y: y, x1:x1, y1:y1 }, function(json){
                boardConnection.newLine(x, y, x1, y1);
            });
        }

        function onDeletedPostit(id){
            $.post('/postit/'+id+'/delete/', function(json){
                boardConnection.deletePostit(id);
                deletePostit(id);
            });
        }

        function deletePostit(id){
            $("#postit_input" + id).remove();
            $("#postit" + id).remove();
        }

        function loadBoardConnection(){
            var host = "localhost";
            var port = "8888";
            var uri = "/ws";
            var ws = new WebSocket("ws://" + host + ":" + port + uri);

            boardConnection = new BoardConnection(ws);

            ws.onmessage = function(evt) {
                var message = $.parseJSON(evt.data);
                var message_type = message["type"];
                switch(message_type){
                    case "new":
                        if(message["args"]["obj"]=="postit"){
                            createPostit(message["args"]["id"], message["args"]["text"],
                                               message["args"]["x"], message["args"]["y"]);
                        }else
                            processingInstance.addLine(message["args"]["x"], message["args"]["y"],
                                                       message["args"]["x1"], message["args"]["y1"]);
                        break;
                    case "update":
                        updatePostitText(message["args"]["postit_id"], message["args"]["text"]);
                        break;
                    case "move":
                        movePostit(message["args"]["postit_id"], message["args"]["x"], message["args"]["y"]);
                        break;
                    case "select":
                        break;
                    case "deselect":
                        break;
                    case "delete":
                        deletePostit(message["args"]["id"]);
                        break;
                    default:
                        return false;
                }
            };

            ws.onclose = function(evt) {};

            ws.onopen = function(evt) {
                boardConnection.subscribe({{ board_id }});
            };
        }

        $(document).ready(function() {
            loadProcessingInstance();
            loadBoardConnection();

            $("#pencil_tool").click(function(){
                    $(this).attr({'class':"pencil_tool_enabled"});
                    $("#postit_tool").attr({'class':"postit_tool_disabled"});
                    processingInstance.selectPencilTool();
                }
            );

            $("#postit_tool").click(
                function(){
                    $(this).attr({'class':"postit_tool_enabled"});
                    $("#pencil_tool").attr({'class':"pencil_tool_disabled"});
                    processingInstance.selectPostitTool();
                }
            );
        });

    </script>
</head>
<body>
    <div id="toolbar">
        <a id="postit_tool" class="postit_tool_enabled"></a>
        <a id="pencil_tool" class="pencil_tool_disabled"></a>
    </div>
    <div id="board">
        <canvas id="board" data-processing-sources="/media/pde/blckboard.pde
        /media/pde/postittool.pde /media/pde/penciltool.pde"></canvas>
    </div>
    <!-- uservoice feedback widget-->
    <div id="resizeDiv">asdf asdf asdf</div>
    <script type="text/javascript">
      var uvOptions = {};
      (function() {
        var uv = document.createElement('script'); uv.type = 'text/javascript'; uv.async = true;
        uv.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'widget.uservoice.com/darBV5SSOPc4nv540weXKg.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(uv, s);
      })();
    </script>
</body>
</html>
