<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>The Board</title>
    <link href="/media/css/board.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css"/>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
    <script type="text/javascript" src="/media/js/processing-1.3.6.js"></script>
    <script type="text/javascript" src="/media/js/json2.js"></script>
    <script type="text/javascript" src="/media/js/boardconnection.js"></script>
    <script type="text/javascript" src="/media/js/postittool.js"></script>
    <script type="application/javascript">
        var processingInstance;
        var boardConnection;
        var boardMessageHandler;
        var postitTool;

        function loadProcessingInstance(){
            var tId=0;
            tId=setInterval(function() {
                processingInstance = Processing.getInstanceById("board");
                if (processingInstance) clearInterval(tId);
            },1);
        }

        function loadBoard(){
            loadLines();
            processingInstance.bindJavaScript(this);
            boardMessageHandler = new BoardMessageHandler(postitTool, processingInstance);
        }

        function loadPostits(){
            $.get('/{{ board_id }}/postits', function(postits){
                postitTool.addPostits(postits);
            });
        }

        function loadLines(){
            $.get('/{{ board_id }}/lines', function(json){
                $.each(json, function(i, line){
                    processingInstance.addLine(line.x, line.y , line.x1,
                    line.y1, line.color_l, line.stroke_w);
                });
            });
        }

        function savePostitPosition(postitId, x, y){
            $.post('/postit/'+postitId+'/update/', { x:x, y:y });
        }

        function savePostitSize(postitId, width, height){
            $.post('/postit/'+postitId+'/update/', { width:width, height:height });
        }

        function createPostit(x, y){
            var width = 120;
            var height = 120;
            $.post('/{{ board_id }}/postit/new/', { text: "", x:x, y:y, width:width, height:height }, function(json){
                postitTool.createPostit(json["postit_id"], "", x, y, width, height);
                onCreatedPostit({{ board_id }} , json["postit_id"], json["x"],json["y"],
                                                           width, height, json["text"]);
            });
        }

        function onCreatedPostit(boardId, postitId, x, y, width, height, text){
            boardConnection.newPostit(boardId, postitId, x, y, width, height, text);
        }

        function onCreatedLine(x, y, x1, y1, color, strokeWidth){
            $.post('/{{ board_id }}/line/new/', { x: x, y: y, x1:x1, y1:y1, color_l:color, stroke_w:strokeWidth }, function(json){
                boardConnection.newLine(x, y, x1, y1, color, strokeWidth);
            });
        }

        function loadBoardConnection(){
            var host = "localhost";
            var port = "8888";
            var uri = "/ws";
            var ws = new WebSocket("ws://" + host + ":" + port + uri);

            boardConnection = new BoardConnection(ws);

            ws.onmessage = function(evt) {
                 boardMessageHandler.handle($.parseJSON(evt.data));
            };

            ws.onclose = function(evt) {};

            ws.onopen = function(evt) {
                boardConnection.subscribe({{ board_id }});
            };
        }

        $(document).ready(function() {
            loadProcessingInstance();
            loadBoardConnection();
            postitTool = new PostitTool(new PostitToolListener(boardConnection));
            loadPostits();

            $("#pencil_tool").click(function(){
                    $(this).attr({'class':"pencil_tool_enabled"});
                    $("#postit_tool").attr({'class':"postit_tool_disabled"});
                    $("#eraser_tool").attr({'class':"eraser_tool_disabled"});
                    $("#pencil_blue_tool").attr({'class':"pencil_blue_tool_disabled"});
                    $("#pencil_green_tool").attr({'class':"pencil_green_tool_disabled"});
                    $("#pencil_red_tool").attr({'class':"pencil_red_tool_disabled"});
                    processingInstance.selectPencilTool("FF000000");
                }
            );

            $("#pencil_red_tool").click(function(){
                    $(this).attr({'class':"pencil_red_tool_enabled"});
                    $("#postit_tool").attr({'class':"postit_tool_disabled"});
                    $("#pencil_tool").attr({'class':"pencil_tool_disabled"});
                    $("#eraser_tool").attr({'class':"eraser_tool_disabled"});
                    $("#pencil_blue_tool").attr({'class':"pencil_blue_tool_disabled"});
                    $("#pencil_green_tool").attr({'class':"pencil_green_tool_disabled"});
                    processingInstance.selectPencilTool("FFFF0000");
                }
            );

             $("#pencil_blue_tool").click(function(){
                    $(this).attr({'class':"pencil_blue_tool_enabled"});
                    $("#postit_tool").attr({'class':"postit_tool_disabled"});
                    $("#pencil_tool").attr({'class':"pencil_tool_disabled"});
                    $("#eraser_tool").attr({'class':"eraser_tool_disabled"});
                    $("#pencil_green_tool").attr({'class':"pencil_green_tool_disabled"});
                    $("#pencil_red_tool").attr({'class':"pencil_red_tool_disabled"});
                    processingInstance.selectPencilTool("FF0000FF");
                }
            );

            $("#pencil_green_tool").click(function(){
                    $(this).attr({'class':"pencil_green_tool_enabled"});
                    $("#postit_tool").attr({'class':"postit_tool_disabled"});
                    $("#pencil_tool").attr({'class':"pencil_tool_disabled"});
                    $("#eraser_tool").attr({'class':"eraser_tool_disabled"});
                    $("#pencil_blue_tool").attr({'class':"pencil_blue_tool_disabled"});
                    $("#pencil_red_tool").attr({'class':"pencil_red_tool_disabled"});
                    processingInstance.selectPencilTool("FF00FF00");
                }
            );


            $("#postit_tool").click(
                function(){
                    $(this).attr({'class':"postit_tool_enabled"});
                    $("#pencil_tool").attr({'class':"pencil_tool_disabled"});
                    $("#eraser_tool").attr({'class':"eraser_tool_disabled"});
                    $("#pencil_blue_tool").attr({'class':"pencil_blue_tool_disabled"});
                    $("#pencil_green_tool").attr({'class':"pencil_green_tool_disabled"});
                    $("#pencil_red_tool").attr({'class':"pencil_red_tool_disabled"});
                    processingInstance.selectPostitTool();
                }
            );

            $("#eraser_tool").click(
                function(){
                    $(this).attr({'class':"eraser_tool_enabled"});
                    $("#pencil_tool").attr({'class':"pencil_tool_disabled"});
                    $("#postit_tool").attr({'class':"postit_tool_disabled"});
                    $("#pencil_blue_tool").attr({'class':"pencil_blue_tool_disabled"});
                    $("#pencil_green_tool").attr({'class':"pencil_green_tool_disabled"});
                    $("#pencil_red_tool").attr({'class':"pencil_red_tool_disabled"});
                    processingInstance.selectEraserTool();
                }
            );
        });

    </script>
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-34473709-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</head>
<body>
    <div id="toolbar">
        <a id="postit_tool" class="postit_tool_enabled"></a>
        <a id="pencil_tool" class="pencil_tool_disabled"></a>
        <a id="pencil_red_tool" class="pencil_red_tool_disabled"></a>
        <a id="pencil_blue_tool" class="pencil_blue_tool_disabled"></a>
        <a id="pencil_green_tool" class="pencil_green_tool_disabled"></a>
        <a id="eraser_tool" class="eraser_tool_disabled"></a>
    </div>
    <div id="board">
        <canvas id="board" data-processing-sources="/media/pde/blckboard.pde
        /media/pde/postittool.pde /media/pde/penciltool.pde"></canvas>
    </div>
    <div id="mapale_logo"><a target="_blank" href="http://www.mapalesoftware.com"><img src="/media/mapale_logo.png"/></a></div>
    <!-- uservoice feedback widget-->
    <script type="text/javascript">
      var uvOptions = {};
      (function() {
        var uv = document.createElement('script'); uv.type = 'text/javascript'; uv.async = true;
        uv.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'widget.uservoice.com/darBV5SSOPc4nv540weXKg.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(uv, s);
      })();
    </script>
</body>
</html>
