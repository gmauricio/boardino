<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Boardino - Project Management Whiteboard</title>
    {% load compress %}
    {% compress css %}
    <link href="/static/css/board.css" rel="stylesheet" type="text/css"/>
    {% endcompress %}
    <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css"/>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
    <script src="http://ajax.cdnjs.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
    <script type="text/javascript" src="/static/js/backbone-min.js"></script>
    <script type="text/javascript" src="/static/js/processing-1.4.1.min.js"></script>
    <script type="text/javascript" src="/static/js/json2.js"></script>
    <script type="text/javascript" src="/static/js/socket.io.min.js"></script>
    {% compress js %}
    <script type="text/javascript" src="/static/js/boardino.js"></script>
    <script type="text/javascript" src="/static/js/boardconnection.js"></script>
    <!--<script type="text/javascript" src="/static/js/postittool.js"></script>-->
    <script type="text/javascript" src="/static/js/toolbar.js"></script>
    <script type="application/javascript">
        var processingInstance;
        var boardConnection;
        var postitTool;
        var connectedUsers = 1;
        var board_id = {{ board_id }}

        function initBoard(){
            processingInstance = Processing.getInstanceById("board_canvas");
            if(!processingInstance)
                setTimeout(function() { initBoard() }, 1000);
            else{
                processingInstance.bindJavaScript(this);
                //postitTool = new PostitTool();
                boardConnection = new BoardConnection(board_id, new BoardMessageHandler(postitTool, processingInstance));
                //postitTool.setListener(new PostitToolListener(boardConnection));
                loadLines();
                //loadPostits();
            }
        };

        function loadLines(){
            $.get('/{{ board_id }}/lines', function(json){
                $.each(json, function(i, line){
                    processingInstance.addLine(line.x, line.y , line.x1,
                    line.y1, line.color_l, line.stroke_w, true);
                });
            });
        }

        function loadPostits(){
            $.get('/{{ board_id }}/postits', function(postits){
                postitTool.addPostits(postits);
            });
        }

        function createPostit(x, y){
            var width = 120;
            var height = 120;
            $.post('/{{ board_id }}/postit/new/', { text: "", x:x, y:y, width:width, height:height }, function(json){
                postitTool.createPostit(json["postit_id"], "", x, y, width, height);
                postitTool.focusPostit(json["postit_id"]);
                boardConnection.newPostit({{ board_id }}, json["postit_id"], json["x"],json["y"], width, height, json["text"]);
            });
        }

        function onCreatedLine(x, y, x1, y1, color, strokeWidth, add_to_local_array){
            $.post('/{{ board_id }}/line/new/', { x: x, y: y, x1:x1, y1:y1, color_l:color, stroke_w:strokeWidth }, function(json){
                boardConnection.newLine(x, y, x1, y1, color, strokeWidth,
                                        add_to_local_array);
            });
        }

        function onCreatingRectLine(x, y, x1, y1, color, strokeWidth, add_to_local_array){
            boardConnection.newLine(x, y, x1, y1, color, strokeWidth, add_to_local_array);
        }

        function clearLines(){
            $.get('/{{ board_id }}/lines/clear/',  function(json){
                 boardConnection.clearLines();
                 processingInstance.clearLines();
            });
        }


        $(document).ready(function() {
            initBoard();
            loadToolbar();

            $("#connected_users").mouseover(function(){
                $(this).text(connectedUsers + " connected users");
            });
            $("#connected_users").mouseout(function(){
                $(this).text(connectedUsers);
            });

            $(window).bind("beforeunload", function() {
                boardConnection.disconnect();
            });
        });

        function loadToolbar(){
            var toolbar = new Toolbar();
            toolbar.addTool($("#eraser_tool").tool(toolbar, {
                    "action": function(){
                        $("#board").css('cursor','url(/static/images/eraser_disabled.ico),default');
                        processingInstance.selectEraserTool();
                    }
            }));

            toolbar.addTool($("#postit_tool").tool(toolbar, {
                    "action": function(){
                        $("#board").css('cursor','url(/static/images/postit_disabled.ico),default');
                        processingInstance.selectPostitTool();
                    }
            }));

            toolbar.addTool($("#selected_pencil_tool").tool(toolbar, {
                    "enabledClass": "pencil_black_tool_enabled",
                    "disabledClass": "pencil_tool_disabled",
                    "action": function(){}
            }));

            toolbar.addTool($("#pencil_black_tool").tool(toolbar, {
                    "action": function(){
                        $("#board").css('cursor','url(/static/images/pencil_disabled.ico),default');
                        processingInstance.selectPencilTool("FF000000");
                        $("#selected_pencil_tool").attr('class', "pencil_black_tool_enabled");
                    }
            }));

            toolbar.addTool($("#pencil_green_tool").tool(toolbar, {
                    "action": function(){
                        $("#board").css('cursor','url(/static/images/pencil_green_disabled.ico),default');
                        processingInstance.selectPencilTool("FF00FF00");
                        $("#selected_pencil_tool").attr('class', "pencil_green_tool_enabled");
                    }
            }));

            toolbar.addTool($("#pencil_red_tool").tool(toolbar, {
                    "action": function(){
                        $("#board").css('cursor','url(/static/images/pencil_red_disabled.ico),default');
                        processingInstance.selectPencilTool("FFFF0000");
                        $("#selected_pencil_tool").attr('class', "pencil_red_tool_enabled");
                    }
            }));

            toolbar.addTool($("#pencil_blue_tool").tool(toolbar, {
                    "action": function(){
                        $("#board").css('cursor','url(/static/images/pencil_blue_disabled.ico),default');
                        processingInstance.selectPencilTool("FF0000FF");
                        $("#selected_pencil_tool").attr('class', "pencil_blue_tool_enabled");
                    }
            }));

            toolbar.addTool($("#clear_lines_tool").tool(toolbar, {
                    "action": function(){
                        clearLines();
                    },
                    "confirmable": true,
                    "exclusive": false
            }));

            toolbar.addTool($("#rectline_tool").tool(toolbar, {
                    "action": function(){
                        $("#board").css('cursor','url(/static/images/rectline_disabled.ico),default');
                        processingInstance.selectRectLineTool("FF000000");
                    }
            }));


            $("#pencil_tool").mouseover(function(){
                $("#pencil_tool").width(200);
                $("#selected_pencil_tool").hide();
                $("#pencil_black_tool").show();
                $("#pencil_green_tool").show();
                $("#pencil_red_tool").show();
                $("#pencil_blue_tool").show();
            });
            $("#pencil_tool").mouseout(function(){
                $("#pencil_tool").width(50);
                $("#selected_pencil_tool").show();
                $("#pencil_black_tool").hide();
                $("#pencil_green_tool").hide();
                $("#pencil_red_tool").hide();
                $("#pencil_blue_tool").hide();
            });
        }

    </script>
    {% endcompress %}
    <meta name = "viewport" content = "initial-scale = 1.0">
</head>
<body>
    <div id="toolbar">
        <a id="postit_tool" class="postit_tool_disabled"></a>
        <div id="pencil_tool" style="height:50px; width: 50px">
            <a id="selected_pencil_tool" class="pencil_tool_disabled"></a>
            <a id="pencil_black_tool" class="pencil_black_tool_disabled"></a>
            <a id="pencil_red_tool" class="pencil_red_tool_disabled"></a>
            <a id="pencil_blue_tool" class="pencil_blue_tool_disabled"></a>
            <a id="pencil_green_tool" class="pencil_green_tool_disabled"></a>
        </div>
        <a id="rectline_tool" class="rectline_tool_disabled"></a>
        <a id="eraser_tool" class="eraser_tool_disabled"></a>
        <a id="clear_lines_tool" class="clear_lines_tool_disabled"></a>
    </div>
    <div id="dialog" title="Cleaning drawings..." style="display: none;">
        Are you sure about this?
    </div>
    <div id="board">
        <canvas id="board_canvas" data-processing-sources="/static/pde/blckboard.pde
        /static/pde/postittool.pde /static/pde/penciltool.pde
        /static/pde/rectlinetool.pde"></canvas>
    </div>
    <div id="boardino_logo"><a href="http://www.boardino.com"><img src="/static/images/logo_small.png"/></a></div>
    <div id="mapale_logo"><a target="_blank" href="http://www.mapalesoftware.com"><img src="/static/images/mapale_logo.png"/></a></div>
    <div id="notifications">
        <div id="connected_users">1</div>
    </div>
    <!-- uservoice feedback widget-->
    <script type="text/javascript">
      var uvOptions = {};
      (function() {
        var uv = document.createElement('script'); uv.type = 'text/javascript'; uv.async = true;
        uv.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'widget.uservoice.com/darBV5SSOPc4nv540weXKg.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(uv, s);
      })();
    </script>
</body>
</html>
