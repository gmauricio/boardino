<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>The Board</title>
    <script src="http://code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript" src="/media/js/processing-1.3.6.js"></script>
    <script type="text/javascript" src="/media/js/json2.js"></script>
    <script type="application/javascript">
        var processingInstance;
        var ws;

        function loadProcessingInstance(){
            var tId=0;
            tId=setInterval(function() {
                processingInstance = Processing.getInstanceById("board");
                if (processingInstance) clearInterval(tId);
            },1);
        }

        function loadBoard(){
            {% for post_it in postits %}
                processingInstance.addPostIt({{post_it.id}},"{{post_it.text}}",{{ post_it.x }},{{ post_it.y }});
            {% endfor %}
        }

        function onPostItMoved(postItId, x, y){
            var message = {
                "type": "move",
                "args": {
                    "channel_id":{{ board_id }},
                    "postit_id":postItId,
                    "x": x,
                    "y": y
                }
            };
            ws.send(JSON.stringify(message));
        }

        $(document).ready(function() {
            loadProcessingInstance();
            var host = "localhost";
            var port = "8888";
            var uri = "/ws";
            ws = new WebSocket("ws://" + host + ":" + port + uri);

            ws.onmessage = function(evt) {
                var message = $.parseJSON(evt.data);
                processingInstance.movePostIt(message["args"]["postit_id"], message["args"]["x"], message["args"]["y"])
            };
            ws.onclose = function(evt) {};
            ws.onopen = function(evt) {
                var message = {
                    "type": "register",
                    "args": {
                        "channel_id":{{ board_id }}
                    }
                };
                ws.send(JSON.stringify(message));
            };


        });

    </script>
</head>
<body>
    <canvas id="board" data-processing-sources="/media/pde/blckboard.pde"></canvas>
</body>
</html>